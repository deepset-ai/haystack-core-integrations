name: Core / Check API reference changes

on:
  pull_request:
    paths:
      - "integrations/**/*.py"
      - "integrations/**/config_docusaurus.yml"

jobs:
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      integrations: ${{ steps.changed.outputs.integrations }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Detect integrations with API reference changes
        id: changed
        shell: python
        env:
          BASE_SHA: ${{ github.event.pull_request.base.sha }}
          RUNNER_TEMP: ${{ runner.temp }}
        run: |
          import json
          import os
          import subprocess
          import sys
          from pathlib import Path

          sys.path.insert(0, ".github/utils")
          from docstrings_checksum import docstrings_checksum

          base_sha = os.environ["BASE_SHA"]
          runner_temp = os.environ["RUNNER_TEMP"]

          def git(*args):
              result = subprocess.run(["git", *args], capture_output=True, text=True)
              return result.stdout.strip(), result.returncode

          # Find integrations with changed .py or config files
          diff_output, _ = git("diff", "--name-only", f"{base_sha}...HEAD",
                               "--", "integrations/**/*.py", "integrations/**/config_docusaurus.yml")
          candidates = sorted({Path(p).parts[1] for p in diff_output.splitlines() if p.startswith("integrations/")})

          # Create base worktree once for docstring comparison
          base_worktree = os.path.join(runner_temp, "base")
          _, rc = git("worktree", "add", base_worktree, base_sha)
          has_worktree = rc == 0

          result = []
          for integration in candidates:
              # If pydoc config changed, always include
              config_diff, _ = git("diff", "--name-only", f"{base_sha}...HEAD",
                                   "--", f"integrations/{integration}/pydoc/config_docusaurus.yml")
              if config_diff:
                  result.append(integration)
                  continue

              # Otherwise, check if docstrings changed
              pr_checksum = docstrings_checksum(Path(".").glob(f"integrations/{integration}/**/*.py"))
              if has_worktree:
                  base_checksum = docstrings_checksum(Path(base_worktree).glob(f"integrations/{integration}/**/*.py"))
              else:
                  # Integration doesn't exist on the base branch (new integration)
                  base_checksum = ""

              if base_checksum != pr_checksum:
                  result.append(integration)

          if has_worktree:
              git("worktree", "remove", base_worktree)

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"integrations={json.dumps(result)}\n")

  generate-docs:
    needs: detect-changes
    if: needs.detect-changes.outputs.integrations != '[]'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        integration: ${{ fromJson(needs.detect-changes.outputs.integrations) }}
    steps:
      - uses: actions/checkout@v6

      - name: Set up Python 3.13
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Install Hatch
        run: pip install --upgrade hatch

      - name: Generate API reference
        working-directory: integrations/${{ matrix.integration }}
        run: |
          hatch run docs
          # Save the generated file before the Haystack checkout overwrites the working tree
          cp ${{ matrix.integration }}.md "${{ runner.temp }}/${{ matrix.integration }}.md"

      - name: Checkout Haystack repo
        uses: actions/checkout@v6
        with:
          repository: deepset-ai/haystack
          ref: main
          sparse-checkout: docs-website

      - name: Sync API reference
        shell: python
        env:
          INTEGRATION_API_REFERENCE: ${{ runner.temp }}/${{ matrix.integration }}.md
        run: |
          import os
          import shutil

          api_ref_file = os.environ['INTEGRATION_API_REFERENCE']

          # Copy to main API reference
          shutil.copy(api_ref_file, "docs-website/reference/integrations-api/")

          # Copy to versioned API reference
          for version_dir in os.scandir("docs-website/reference_versioned_docs"):
              if version_dir.is_dir():
                  # example: docs-website/reference_versioned_docs/version-2.17/integrations-api
                  integrations_api_ref_dir = os.path.join(version_dir.path, "integrations-api")
                  shutil.copy(api_ref_file, integrations_api_ref_dir)

      - name: Install Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "22"

      - name: Build docs-website
        working-directory: docs-website
        run: |
          npm install
          npm run build
